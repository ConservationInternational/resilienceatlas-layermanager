!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("lodash/compact"),require("lodash/isEmpty"),require("lodash/isEqual")):"function"==typeof define&&define.amd?define(["axios","lodash/compact","lodash/isEmpty","lodash/isEqual"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).LayerManager=t(e.axios,e.compact,e.isEmpty,e.isEqual)}(this,function(e,t,s,r){"use strict";function i(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var r=s.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function n(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),s.push.apply(s,r)}return s}function o(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?n(Object(s),!0).forEach(function(t){i(e,t,s[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):n(Object(s)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))})}return e}const a={"Content-Type":"application/json"},c=(t,s={})=>e.get(t,o({headers:a},s)),h=(e,t={})=>{let s=e;return Object.keys(t).forEach(e=>{s=s.replace(new RegExp(`{{${e}}}`,"g"),t[e]).replace(new RegExp(`{${e}}`,"g"),t[e])}),s},l=(e,s={})=>{let r,i=e;return Object.keys(s).forEach(e=>{r=`${t(Object.keys(s[e]).map(t=>{const r=s[e][t];if(Array.isArray(r)&&r.length){return`${t} IN (${r.map(e=>"number"!=typeof e?`'${e}'`:e).join(", ")})`}return!Array.isArray(r)&&r?"number"!=typeof r?`${t} = '${r}'`:`${t} = ${r}`:null})).join(" AND ")}`,r=r&&e.startsWith("where")?`WHERE ${r}`:r&&e.startsWith("and")?`AND ${r}`:"",i=i.replace(new RegExp(`{{${e}}}`,"g"),r),i=i.replace(new RegExp(`{${e}}`,"g"),r)}),i},d=(e,t={},s={})=>{let r=e;return"string"==typeof r&&(r=h(r,t),r=l(r,s)),r},p=Symbol("CANCELED"),{L:u}="undefined"!=typeof window?window:{},y=t=>{if(!u)throw new Error("Leaflet must be defined.");const{layerConfig:s,params:r,sqlParams:i,interactivity:n}=t;return!1===s.parse||JSON.parse(d(JSON.stringify(s),r,i)),new Promise((s,r)=>{(t=>{const{layerConfig:s,params:r,sqlParams:i,interactivity:n}=t,a=!1===s.parse?s:JSON.parse(d(JSON.stringify(s),r,i)),h=JSON.stringify({version:"1.3.0",stat_tag:"API",layers:a.body.layers.map(e=>n&&n.length?o(o({},e),{},{options:o(o({},e.options),{},{interactivity:n.split(", ")})}):e)}),l=`?stat_tag=API&config=${encodeURIComponent(h)}`,u=`https://${a.account}-cdn.resilienceatlas.org/user/ra/api/v1/map${l}`,{layerRequest:y}=t;y&&y.cancel("Operation canceled by the user.");const f=e.CancelToken.source();return t.set("layerRequest",f),c(u,{cancelToken:f.token}).then(e=>e.status>400?(console.error(e),!1):e.data).catch(t=>{if(e.isCancel(t))return p;throw t})})(t).then(e=>{if(e===p)return;const r=`https://${e.cdn_url.https}/ra/api/v1/map/${e.layergroupid}/{z}/{x}/{y}.png`,i=u.tileLayer(r);if(n&&n.length){const r=`https://${e.cdn_url.https}/ra/api/v1/map/${e.layergroupid}/0/{z}/{x}/{y}.grid.json`,n=u.utfGrid(r),o=u.LayerGroup.extend({group:!0,setOpacity:e=>{t.mapLayer.getLayers().forEach(t=>{t.setOpacity(e)})}});return s(new o([i,n]))}return s(i)}).catch(e=>r(e))})};y.getBounds=t=>{if(!u)throw new Error("Leaflet must be defined.");return new Promise((s,r)=>{(t=>{const{layerConfig:s,params:r,sqlParams:i,type:n}=t;let{sql:o}=t;"raster"===n&&(o=`SELECT ST_Union(ST_Transform(ST_Envelope(the_raster_webmercator), 4326)) as the_geom FROM (${o}) as t`);const a=`\n    SELECT ST_XMin(ST_Extent(the_geom)) as minx,\n    ST_YMin(ST_Extent(the_geom)) as miny,\n    ST_XMax(ST_Extent(the_geom)) as maxx,\n    ST_YMax(ST_Extent(the_geom)) as maxy\n    from (${o}) as subq\n  `,h=`https://${(!1===s.parse?s:JSON.parse(d(JSON.stringify(s),r,i))).account}-cdn.resilienceatlas.org/user/ra/api/v2/sql?q=${a.replace(/\n/g," ")}`,{boundsRequest:l}=t;l&&l.cancel("Operation canceled by the user.");const u=e.CancelToken.source();return t.set("boundsRequest",u),c(h,{cancelToken:u.token}).then(e=>e.status>400?(console.error(e),!1):e.data).catch(t=>{if(e.isCancel(t))return p;throw t})})(t).then(e=>{if(e===p)return;const{maxy:t,maxx:r,miny:i,minx:n}=e.rows[0];return s([[t,r],[i,n]])}).catch(r)})};const{L:f}="undefined"!=typeof window?window:{},m=f&&f.GridLayer.extend({tiles:{},createTile({x:e,y:t,z:s},r){const{params:i}=this.options,n=d(i.url,o({x:e,y:t,z:s},i)),a=Object.keys(this.tiles);for(let e=0;e<a.length;e++)this.tiles[a[e]].z!==s&&delete this.tiles[a[e]];this.done=r;const c=f.DomUtil.create("canvas","leaflet-tile"),h=c.getContext("2d"),l=this.getTileSize();return c.width=l.x,c.height=l.y,this.getTile({x:e,y:t,z:s}).then(i=>{this.cacheTile(o({id:n,tile:c,ctx:h,image:i},{x:e,y:t,z:s})),this.drawCanvas(n),r(null,c)}).catch(e=>{r(e,c)}),c},getTile({x:e,y:t,z:s}){const{params:r,sqlParams:i}=this.options,{url:n,dataMaxZoom:a=20}=r,c=s-a,h=d(r.url,o({x:e,y:t,z:s},r));let l={x:e,y:t,z:s};c>0&&(l={x:Math.floor(e/2**c),y:Math.floor(t/2**c),z:a});const p=d(n,o(o({},l),r),i);return new Promise((e,t)=>{this.tiles[h]&&e(this.tiles[h].image);const s=new XMLHttpRequest;s.addEventListener("load",s=>{const{response:r}=s.currentTarget,i=URL.createObjectURL(r),n=new Image;n.src=i,n.onload=()=>{n.crossOrigin="",e(n),URL.revokeObjectURL(i)},n.onerror=()=>{t(new Error("Can't load image"))}}),s.addEventListener("error",t),s.open("GET",p,!0),s.responseType="blob",s.send()})},cacheTile(e){this.tiles[e.id]=o(o({},this.tiles[e.id]),e)},drawCanvas(e){"use asm";if(!this.tiles[e]){return}const{tile:t,ctx:s,image:r,x:i,y:n,z:o}=this.tiles[e];if(!t||!s||!r||typeof i==="undefined"||typeof n==="undefined"||typeof o==="undefined"){delete this.tiles[e];return}const{params:a,decodeParams:c,decodeFunction:h}=this.options;const{dataMaxZoom:l=20}=a;const d=o-l;s.clearRect(0,0,t.width,t.width);if(d<0){s.drawImage(r,0,0)}else{s.imageSmoothingEnabled=false;s.mozImageSmoothingEnabled=false;const e=t.width/2**d*(i%2**d)||0;const o=t.height/2**d*(n%2**d)||0;const a=t.width/2**d||0;const c=t.height/2**d||0;s.drawImage(r,e,o,a,c,0,0,t.width,t.height)}const p=s.getImageData(0,0,t.width,t.height);if(typeof h==="function"){h(p.data,t.width,t.height,o,c)}s.putImageData(p,0,0)},reDraw(e){this.options.params=e.params,this.options.sqlParams=e.sqlParams,this.options.decodeParams=e.decodeParams;const{params:t,sqlParams:s}=e;t&&t.url&&Object.keys(this.tiles).map(e=>{const{x:r,y:i,z:n}=this.tiles[e],a=d(t.url,o(o({x:r,y:i,z:n},t),{},{sqlParams:s}));return this.drawCanvas(a)})}}),g=Symbol("CANCELED"),w=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class b{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,s]=new Uint8Array(e,0,2);if(0xdb!==t)throw new Error("Data does not appear to be in a KDBush format.");const r=s>>4;if(1!==r)throw new Error(`Got v${r} data when expected v1.`);const i=w[0x0f&s];if(!i)throw new Error("Unrecognized array type.");const[n]=new Uint16Array(e,2,1),[o]=new Uint32Array(e,4,1);return new b(o,n,i,e)}constructor(e,t=64,s=Float64Array,r){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const i=w.indexOf(this.ArrayType),n=2*e*this.ArrayType.BYTES_PER_ELEMENT,o=e*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-o%8)%8;if(i<0)throw new Error(`Unexpected typed array class: ${s}.`);r&&r instanceof ArrayBuffer?(this.data=r,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+o+a,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+n+o+a),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+o+a,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([0xdb,16+i]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=t,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return v(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,s,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:n,nodeSize:o}=this,a=[0,i.length-1,0],c=[];for(;a.length;){const h=a.pop()||0,l=a.pop()||0,d=a.pop()||0;if(l-d<=o){for(let o=d;o<=l;o++){const a=n[2*o],h=n[2*o+1];a>=e&&a<=s&&h>=t&&h<=r&&c.push(i[o])}continue}const p=d+l>>1,u=n[2*p],y=n[2*p+1];u>=e&&u<=s&&y>=t&&y<=r&&c.push(i[p]),(0===h?e<=u:t<=y)&&(a.push(d),a.push(p-1),a.push(1-h)),(0===h?s>=u:r>=y)&&(a.push(p+1),a.push(l),a.push(1-h))}return c}within(e,t,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:i,nodeSize:n}=this,o=[0,r.length-1,0],a=[],c=s*s;for(;o.length;){const h=o.pop()||0,l=o.pop()||0,d=o.pop()||0;if(l-d<=n){for(let s=d;s<=l;s++)E(i[2*s],i[2*s+1],e,t)<=c&&a.push(r[s]);continue}const p=d+l>>1,u=i[2*p],y=i[2*p+1];E(u,y,e,t)<=c&&a.push(r[p]),(0===h?e-s<=u:t-s<=y)&&(o.push(d),o.push(p-1),o.push(1-h)),(0===h?e+s>=u:t+s>=y)&&(o.push(p+1),o.push(l),o.push(1-h))}return a}}function v(e,t,s,r,i,n){if(i-r<=s)return;const o=r+i>>1;L(e,t,o,r,i,n),v(e,t,s,r,o-1,1-n),v(e,t,s,o+1,i,1-n)}function L(e,t,s,r,i,n){for(;i>r;){if(i-r>600){const o=i-r+1,a=s-r+1,c=Math.log(o),h=0.5*Math.exp(2*c/3),l=0.5*Math.sqrt(c*h*(o-h)/o)*(a-o/2<0?-1:1);L(e,t,s,Math.max(r,Math.floor(s-a*h/o+l)),Math.min(i,Math.floor(s+(o-a)*h/o+l)),n)}const o=t[2*s+n];let a=r,c=i;for(x(e,t,r,s),t[2*i+n]>o&&x(e,t,r,i);a<c;){for(x(e,t,a,c),a++,c--;t[2*a+n]<o;)a++;for(;t[2*c+n]>o;)c--}t[2*r+n]===o?x(e,t,r,c):(c++,x(e,t,c,i)),c<=s&&(r=c+1),s<=c&&(i=c-1)}}function x(e,t,s,r){O(e,s,r),O(t,2*s,2*r),O(t,2*s+1,2*r+1)}function O(e,t,s){const r=e[t];e[t]=e[s],e[s]=r}function E(e,t,s,r){const i=e-s,n=t-r;return i*i+n*n}const _={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e},P=Math.fround||(S=new Float32Array(1),e=>(S[0]=+e,S[0]));var S;class T{constructor(e){this.options=Object.assign(Object.create(_),e),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){const{log:t,minZoom:s,maxZoom:r}=this.options;t&&console.time("total time");const i=`prepare ${e.length} points`;t&&console.time(i),this.points=e;const n=[];for(let t=0;t<e.length;t++){const s=e[t];if(!s.geometry)continue;const[r,i]=s.geometry.coordinates,o=P(C(r)),a=P(q(i));n.push(o,a,1/0,t,-1,1),this.options.reduce&&n.push(0)}let o=this.trees[r+1]=this._createTree(n);t&&console.timeEnd(i);for(let e=r;e>=s;e--){const s=+Date.now();o=this.trees[e]=this._createTree(this._cluster(o,e)),t&&console.log("z%d: %d clusters in %dms",e,o.numItems,+Date.now()-s)}return t&&console.timeEnd("total time"),this}getClusters(e,t){let s=((e[0]+180)%360+360)%360-180;const r=Math.max(-90,Math.min(90,e[1]));let i=180===e[2]?180:((e[2]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)s=-180,i=180;else if(s>i){const e=this.getClusters([s,r,180,n],t),o=this.getClusters([-180,r,i,n],t);return e.concat(o)}const o=this.trees[this._limitZoom(t)],a=o.range(C(s),q(n),C(i),q(r)),c=o.data,h=[];for(const e of a){const t=this.stride*e;h.push(c[t+5]>1?A(c,t,this.clusterProps):this.points[c[t+3]])}return h}getChildren(e){const t=this._getOriginId(e),s=this._getOriginZoom(e),r="No cluster with the specified id.",i=this.trees[s];if(!i)throw new Error(r);const n=i.data;if(t*this.stride>=n.length)throw new Error(r);const o=this.options.radius/(this.options.extent*Math.pow(2,s-1)),a=n[t*this.stride],c=n[t*this.stride+1],h=i.within(a,c,o),l=[];for(const t of h){const s=t*this.stride;n[s+4]===e&&l.push(n[s+5]>1?A(n,s,this.clusterProps):this.points[n[s+3]])}if(0===l.length)throw new Error(r);return l}getLeaves(e,t,s){t=t||10,s=s||0;const r=[];return this._appendLeaves(r,e,t,s,0),r}getTile(e,t,s){const r=this.trees[this._limitZoom(e)],i=Math.pow(2,e),{extent:n,radius:o}=this.options,a=o/n,c=(s-a)/i,h=(s+1+a)/i,l={features:[]};return this._addTileFeatures(r.range((t-a)/i,c,(t+1+a)/i,h),r.data,t,s,i,l),0===t&&this._addTileFeatures(r.range(1-a/i,c,1,h),r.data,i,s,i,l),t===i-1&&this._addTileFeatures(r.range(0,c,a/i,h),r.data,-1,s,i,l),l.features.length?l:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const s=this.getChildren(e);if(t++,1!==s.length)break;e=s[0].properties.cluster_id}return t}_appendLeaves(e,t,s,r,i){const n=this.getChildren(t);for(const t of n){const n=t.properties;if(n&&n.cluster?i+n.point_count<=r?i+=n.point_count:i=this._appendLeaves(e,n.cluster_id,s,r,i):i<r?i++:e.push(t),e.length===s)break}return i}_createTree(e){const t=new b(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let s=0;s<e.length;s+=this.stride)t.add(e[s],e[s+1]);return t.finish(),t.data=e,t}_addTileFeatures(e,t,s,r,i,n){for(const o of e){const e=o*this.stride,a=t[e+5]>1;let c,h,l;if(a)c=M(t,e,this.clusterProps),h=t[e],l=t[e+1];else{const s=this.points[t[e+3]];c=s.properties;const[r,i]=s.geometry.coordinates;h=C(r),l=q(i)}const d={type:1,geometry:[[Math.round(this.options.extent*(h*i-s)),Math.round(this.options.extent*(l*i-r))]],tags:c};let p;p=a||this.options.generateId?t[e+3]:this.points[t[e+3]].id,void 0!==p&&(d.id=p),n.features.push(d)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){const{radius:s,extent:r,reduce:i,minPoints:n}=this.options,o=s/(r*Math.pow(2,t)),a=e.data,c=[],h=this.stride;for(let s=0;s<a.length;s+=h){if(a[s+2]<=t)continue;a[s+2]=t;const r=a[s],l=a[s+1],d=e.within(a[s],a[s+1],o),p=a[s+5];let u=p;for(const e of d){const s=e*h;a[s+2]>t&&(u+=a[s+5])}if(u>p&&u>=n){let e,n=r*p,o=l*p,y=-1;const f=(s/h<<5)+(t+1)+this.points.length;for(const r of d){const c=r*h;if(a[c+2]<=t)continue;a[c+2]=t;const l=a[c+5];n+=a[c]*l,o+=a[c+1]*l,a[c+4]=f,i&&(e||(e=this._map(a,s,!0),y=this.clusterProps.length,this.clusterProps.push(e)),i(e,this._map(a,c)))}a[s+4]=f,c.push(n/u,o/u,1/0,f,-1,u),i&&c.push(y)}else{for(let e=0;e<h;e++)c.push(a[s+e]);if(u>1)for(const e of d){const s=e*h;if(!(a[s+2]<=t)){a[s+2]=t;for(let e=0;e<h;e++)c.push(a[s+e])}}}}return c}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t,s){if(e[t+5]>1){const r=this.clusterProps[e[t+6]];return s?Object.assign({},r):r}const r=this.points[e[t+3]].properties,i=this.options.map(r);return s&&i===r?Object.assign({},i):i}}function A(e,t,s){return{type:"Feature",id:e[t+3],properties:M(e,t,s),geometry:{type:"Point",coordinates:[(r=e[t],360*(r-0.5)),I(e[t+1])]}};var r}function M(e,t,s){const r=e[t+5],i=r>=10000?`${Math.round(r/1000)}k`:r>=1000?Math.round(r/100)/10+"k":r,n=e[t+6],o=-1===n?{}:Object.assign({},s[n]);return Object.assign(o,{cluster:!0,cluster_id:e[t+3],point_count:r,point_count_abbreviated:i})}function C(e){return e/360+0.5}function q(e){const t=Math.sin(e*Math.PI/180),s=0.5-0.25*Math.log((1+t)/(1-t))/Math.PI;return s<0?0:s>1?1:s}function I(e){const t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}const{L:j}="undefined"!=typeof window?window:{},$={50:25,100:30,1e3:40},k=j&&j.GeoJSON.extend({initialize(t){const s=this;j.GeoJSON.prototype.initialize.call(this,[]);const{layerConfig:r,events:i,decodeClusters:n}=t;if(!n)return void console.warn("You must provide a decodeClusters function");const{html:a,sizes:h=$,clusterIcon:l,icon:d}=t.layerConfig||{};j.Util.setOptions(this,{pointToLayer(e,t){if(!(e.properties&&e.properties.cluster))return j.marker(t,{icon:j.icon(o({iconSize:[35,35]},d))});const s=e.properties.point_count;let r=null;if("function"==typeof h)r=()=>h(s);else{const e=Object.keys(h).find(e=>s<=parseInt(e,10)),t=h[e];r=j.point(t,t)}return j.marker(t,{icon:j.divIcon(o({iconSize:r,html:a&&"function"==typeof a?a(e):`<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; ${l.color?`background-color: ${l.color};`:""}">${e.properties.point_count_abbreviated}</div>`},l))})},onEachFeature(e,t){e.properties&&e.properties.cluster?t.on({click:()=>s.setMapView(e)}):i&&t.on(Object.keys(i).reduce((t,s)=>o(o({},t),{},{[s]:t=>i[s](o(o({},t),{},{data:e.properties}))}),{}))}});const{clusterConfig:p}=r||{};this.supercluster=T(o({radius:80,maxZoom:16},p)),(t=>{const{layerConfig:s,layerRequest:r}=t,{url:i}=s.body;r&&r.cancel("Operation canceled by the user.");const n=e.CancelToken.source();return t.set("layerRequest",n),c(i,{cancelToken:n.token}).then(e=>e.status>400?(console.error(e),!1):e.data).catch(t=>{if(e.isCancel(t))return g;throw t})})(t).then(e=>{if(e===g)return;const t=n(e);this.supercluster.load(t),this.update()})},setMapView(e){const t=e.geometry.coordinates,s=this.supercluster.getClusterExpansionZoom(e.properties.cluster_id);this._map.setView(t.reverse(),s)},onAdd(e){j.GeoJSON.prototype.onAdd.call(this,e),e.on("moveend zoomend",this.onMove,this)},onRemove(e){e.off("moveend zoomend",this.onMove,this),this.clear()},onMove(){this.clear(),this.update()},update(){const e=this._map.getZoom(),t=this._map.getBounds(),s=[t._southWest.lng,t._southWest.lat,t._northEast.lng,t._northEast.lat],r=this.supercluster.getClusters(s,e);this.addData(r)},clear(){j.GeoJSON.prototype.clearLayers.call(this,[])}}),{L:z}="undefined"!=typeof window?window:{},R=z&&z.GridLayer.extend({tiles:{},cache:{},mouseOn:null,createTile({z:e}){const t=Object.keys(this.tiles);for(let s=0;s<t.length;s++)this.tiles[t[s]].z!==e&&delete this.tiles[t[s]];const s=z.DomUtil.create("div","leaflet-tile"),r=this.getTileSize();return s.width=r.x,s.height=r.y,s},onAdd(e){z.GridLayer.prototype.onAdd.call(this,e),this.map=e;const t=Math.round(this.map.getZoom());t>this.options.maxZoom||t<this.options.minZoom||(e.on("click",this.click,this),e.on("mousemove",this.move,this))},onRemove(){const{map:e}=this;e.off("click",this.click,this),e.off("mousemove",this.move,this)},click(e){this.fire("click",this.objectForEvent(e))},move(e){const t=this.objectForEvent(e);t.data!==this.mouseOn?(this.mouseOn&&this.fire("mouseout",{latlng:e.latlng,data:this.mouseOn}),t.data&&this.fire("mouseover",t),this.mouseOn=t.data):t.data&&this.fire("mousemove",t)},objectForEvent:e=>z.extend({latlng:e.latlng,data:null},e)}),{L:N}="undefined"!=typeof window?window:{},Z=eval,D=e=>{if(!N)throw new Error("Leaflet must be defined.");const{layerConfig:t,params:s,sqlParams:r,decodeParams:i,interactivity:n}=e;let a;const c=!1===t.parse?t:JSON.parse(d(JSON.stringify(t),s,r));switch(c.body.crs&&N.CRS[c.body.crs]&&(c.body.crs=N.CRS[c.body.crs.replace(":","")],c.body.pane="tilePane"),c.type){case"wms":a=N.tileLayer.wms(c.url||c.body.url,c.body);break;case"tileLayer":if(JSON.stringify(c.body).indexOf('style: "function')>=0&&(c.body.style=Z(`(${c.body.style})`)),a=i&&c.canvas?new m(o({},e)):N.tileLayer(c.url||c.body.url,c.body),n){const t=new R,s=N.LayerGroup.extend({group:!0,setOpacity:t=>{e.mapLayer.getLayers().forEach(e=>{e.setOpacity(t)})}});a=new s([a,t])}break;case"cluster":JSON.stringify(c.body).indexOf('style: "function')>=0&&(c.body.style=Z(`(${c.body.style})`)),a=new k(e);break;default:a=N[c.type](c.body,c.options||{})}return new Promise((e,t)=>{a?e(a):t(new Error('"type" specified in layer spec doesn`t exist'))})};D.getBounds=e=>{if(!N)throw new Error("Leaflet must be defined.");const{layerConfig:t,params:s,sqlParams:r}=e,i=!1===t.parse?t:JSON.parse(d(JSON.stringify(t),s,r)),{bbox:n}=i;return new Promise(e=>{if(n){e([[n[1],n[0]],[n[3],n[2]]])}else e(null)})};const{L:B}="undefined"!=typeof window?window:{},U=eval,J=e=>{if(!B)throw new Error("Leaflet must be defined.");if(!B.esri)throw new Error("To support this layer you should add esri library for Leaflet.");const{layerConfig:t,interactivity:s,params:r,sqlParams:i}=e,n=!1===t.parse?t:JSON.parse(d(JSON.stringify(t),r,i)),a=JSON.stringify(n.body||{}).replace(/"mosaic-rule":/g,'"mosaicRule":').replace(/"mosaic_rule":/g,'"mosaicRule":').replace(/"use-cors":/g,'"useCors":').replace(/"use_cors":/g,'"useCors":');return B[n.type]?new D(o({},e)):new Promise((t,r)=>{if(!B.esri[n.type])return r(new Error('"type" specified in layer spec doesn`t exist'));const i=JSON.parse(a);let o;if(i.pane="tilePane",i.useCors=!0,i.style&&i.style.indexOf("function")>=0&&(i.style=U(`(${i.style})`)),o=B.esri[n.type](i),!o)return r();if(o.on("load",()=>{o.setZIndex(e.zIndex)}),o.on("requesterror",e=>console.error(e)),o.setZIndex||(o.setZIndex=e=>{o._currentImage&&(o._currentImage._image.style.zIndex=e)}),s){const t=new R,s=B.LayerGroup.extend({group:!0,setOpacity:t=>{e.mapLayer.getLayers().forEach(e=>{e.setOpacity(t)})}});o=new s([o,t])}return t(o)})},{L:F}="undefined"!=typeof window?window:{},G=e=>{if(!F)throw new Error("Leaflet must be defined.");const{id:t,layerConfig:s,interactivity:r,params:i,sqlParams:n,decodeParams:a}=e,c=`https://api.resourcewatch.org/v1/layer/${t}/tile/gee/{z}/{x}/{y}`,h=!1===s.parse?s:JSON.parse(d(JSON.stringify(s),i,n));let l;if("tileLayer"===h.type)l=a?new m(o({},e)):F.tileLayer(c,h.body);else l=F.tileLayer(c,h.body);if(r){const t=new R,s=F.LayerGroup.extend({group:!0,setOpacity:t=>{e.mapLayer.getLayers().forEach(e=>{e.setOpacity(t)})}});l=new s([l,t])}return new Promise((e,t)=>{l?e(l):t(new Error('"type" specified in layer spec doesn`t exist'))})},{L:V}="undefined"!=typeof window?window:{},W=V&&new V.LatLngBounds(new V.LatLng(49.4966745,-66.357422),new V.LatLng(24.6070691,-131.660156)),Y=e=>{const{id:t,layerConfig:s,interactivity:r}=e,{period:i}=s,n=(i||{}).value||"1971",a=`https://api.resourcewatch.org/v1/layer/${t}/tile/loca/{z}/{x}/{y}?year=${new Date(n).toISOString()}`;let c=V.tileLayer(a,o(o({},s.body),{},{minNativeZoom:4,bounds:W}));if(r){const t=new R,s=V.LayerGroup.extend({group:!0,setOpacity:t=>{e.mapLayer.getLayers().forEach(e=>{e.setOpacity(t)})}});c=new s([c,t])}return new Promise(e=>{e(c)})},{L:X}="undefined"!=typeof window?window:{},H=e=>{const{id:t,layerConfig:s,interactivity:r}=e,{period:i}=s,n=(i||{}).value||"1971-01-01",o=`https://api.resourcewatch.org/v1/layer/${t}/tile/nexgddp/{z}/{x}/{y}?year=${new Date(n).toISOString()}`;let a=X.tileLayer(o,s.body);if(r){const t=new R,s=X.LayerGroup.extend({group:!0,setOpacity:t=>{e.mapLayer.getLayers().forEach(e=>{e.setOpacity(t)})}});a=new s([a,t])}return new Promise(e=>{e(a)})};class K{constructor(e={}){i(this,"opacity",1),i(this,"visibility",!0),Object.assign(this,e,{changedAttributes:{}})}get(e){return this[e]}set(e,t){return this[e]=t,this}update(e){const t=o({},this),s=o({},e);this.set("changedAttributes",{}),Object.keys(s).forEach(e=>{r(t[e],s[e])||(this.changedAttributes[e]=s[e],this.set(e,s[e]))})}}class Q{constructor(e,t){var s;this.map=e,this.plugin=new t(this.map),(s=this.plugin)&&["add","remove","setVisibility","setOpacity","setEvents","setZIndex","setLayerConfig","setParams","setDecodeParams","getLayerByProvider"].forEach(e=>{s[e]||console.error(`The ${e} function is required for layer manager plugins`)}),this.layers=[],this.promises={},this.pendingRequests={}}renderLayers(){return this.layers.length>0?(this.layers.forEach(e=>{const{changedAttributes:t}=e,{sqlParams:s,params:r,layerConfig:i}=t,n=Object.keys(t).length>0,o=s||r||i;if(!e.mapLayer||n){if(e.mapLayer&&n&&!o)return this.updateLayer(e),void e.set("changedAttributes",{});e.mapLayer&&o&&this.updateLayer(e),e.mapLayer||this.pendingRequests[e.id]||(this.requestLayer(e),this.requestLayerBounds(e)),e.set("changedAttributes",{})}}),0===Object.keys(this.promises).length?Promise.resolve(this.layers):Promise.all(Object.values(this.promises)).then(()=>this.layers).then(()=>{this.promises={}})):Promise.resolve(this.layers)}add(e,t={opacity:1,visibility:!0,zIndex:0,interactivity:null}){return void 0===e?(console.error("layers is required"),this):Array.isArray(e)?(e.forEach(e=>{const s=this.layers.find(t=>t.id===e.id),r=o(o({},e),t);s?s.update(r):this.layers.push(new K(r))}),this.layers):(console.error("layers should be an array"),this)}updateLayer(e){const{opacity:t,visibility:r,zIndex:i,params:n,sqlParams:o,decodeParams:a,layerConfig:c,events:h}=e.changedAttributes;void 0!==t&&this.plugin.setOpacity(e,t),void 0!==r&&this.plugin.setOpacity(e,r?e.opacity:0),void 0!==i&&this.plugin.setZIndex(e,i),void 0!==h&&this.setEvents(e),s(c)||this.plugin.setLayerConfig(e),s(n)||this.plugin.setParams(e),s(o)||this.plugin.setParams(e),s(a)||this.plugin.setDecodeParams(e)}remove(e){const t=this.layers.slice(0),s=Array.isArray(e)?e:[e];this.layers.forEach((e,r)=>{s?s.includes(e.id)&&(this.plugin.remove(e),t.splice(r,1)):this.plugin.remove(e)}),this.layers=s?t:[]}setOpacity(e,t){const s=this.layers.filter(t=>e.includes(t.id));s.length?s.forEach(e=>{this.plugin.setOpacity(e,t)}):console.error("Can't find the layer")}setVisibility(e,t){const s=this.layers.filter(t=>e.includes(t.id));s.length?s.forEach(e=>{this.plugin.setVisibility(e,t)}):console.error("Can't find the layer")}setZIndex(e,t){const s=this.layers.filter(t=>e.includes(t.id));s.length?s.forEach(e=>{this.plugin.setZIndex(e,t)}):console.error("Can't find the layer")}setEvents(e){const{events:t}=e;t&&this.plugin.setEvents(e)}fitMapToLayer(e){if("function"!=typeof this.plugin.fitMapToLayer)return void console.error("This plugin does not support fitting map bounds to layer yet.");const t=this.layers.find(t=>t.id===e);t&&this.plugin.fitMapToLayer(t)}requestLayer(e){const{provider:t}=e,s=this.plugin.getLayerByProvider(t);return s?(this.pendingRequests[e.id]=!0,this.promises[e.id]=s.call(this,e).then(t=>{console.log("[LayerManager] Layer promise resolved:",e.id,t);const s=t;e.set("mapLayer",s),delete this.pendingRequests[e.id],console.log("[LayerManager] Calling requestLayerSuccess for:",e.id),this.requestLayerSuccess(e),this.setEvents(e)}).catch(t=>{delete this.pendingRequests[e.id],console.error(`Error loading layer ${e.id}:`,t)}),this):(this.promises[e.id]=Promise.reject(new Error(`${t} provider is not yet supported.`)),!1)}requestLayerSuccess(e){console.log("[LayerManager] requestLayerSuccess - adding to map:",e.id,e.mapLayer),this.plugin.add(e),console.log("[LayerManager] Layer added to map, setting properties"),this.plugin.setZIndex(e,e.zIndex),this.plugin.setOpacity(e,e.opacity),this.plugin.setVisibility(e,e.visibility),console.log("[LayerManager] Layer setup complete:",e.id)}requestLayerBounds(e){const{provider:t}=e,s=this.plugin.getLayerBoundsByProvider(t);if(!s)return!1;const r=`${e.id}_bounds`;return!this.pendingRequests[r]&&(this.pendingRequests[r]=!0,this.promises[r]=s.call(this,e).then(t=>{delete this.pendingRequests[r],e.set("mapLayerBounds",t)}).catch(t=>{delete this.pendingRequests[r],console.error(`Error loading bounds for layer ${e.id}:`,t)}),this)}}return Q.PluginLeaflet=class{constructor(e){i(this,"events",{}),i(this,"method",{cartodb:y,carto:y,raster:y,arcgis:J,featureservice:J,mapservice:J,tileservice:J,esrifeatureservice:J,esrimapservice:J,esritileservice:J,gee:G,loca:Y,nexgddp:H,leaflet:D,wms:D}),i(this,"setEvents",e=>{const{mapLayer:t,events:s}=e;return"cluster"!==e.layerConfig.type&&(this.events[e.id]&&Object.keys(this.events[e.id]).forEach(e=>{t.group?t.eachLayer(t=>{t.off(e)}):t.off(e)}),Object.keys(s).forEach(e=>{t.group?t.eachLayer(t=>{t.on(e,s[e])}):t.on(e,s[e])}),this.events[e.id]=s),this}),i(this,"fitMapToLayer",e=>{const t=e.get("mapLayerBounds");t&&this.map.fitBounds(t)}),this.map=e}add(e){const{mapLayer:t}=e;this.map.addLayer(t)}remove(e){const{mapLayer:t,events:s}=e;s&&t&&Object.keys(s).forEach(e=>{t.group?t.eachLayer(t=>{t.off(e)}):t.off(e)}),t&&this.map.removeLayer(t)}getLayerByProvider(e){return this.method[e]}getLayerBoundsByProvider(e){return this.method[e].getBounds}setZIndex(e,t){const{mapLayer:s}=e;return s.setZIndex(t),this}setOpacity(e,t){const{mapLayer:s}=e;return"function"==typeof s.setOpacity&&s.setOpacity(t),"function"==typeof s.setStyle&&s.setStyle({opacity:t}),this}setVisibility(e,t){const{opacity:s}=e;this.setOpacity(e,t?s:0)}setParams(e){this.remove(e)}setLayerConfig(e){this.remove(e)}setDecodeParams(e){const{mapLayer:t,params:s,sqlParams:r,decodeParams:i,decodeFunction:n}=e;return t.group?t.eachLayer(e=>{e.reDraw&&e.reDraw({decodeParams:i,decodeFunction:n,params:s,sqlParams:r})}):t.reDraw({decodeParams:i,decodeFunction:n,params:s,sqlParams:r}),this}},Q.replace=d,Q.substitution=h,Q.concatenation=l,Q});
