!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("lodash/compact"),require("lodash/isEqual"),require("lodash/isEmpty")):"function"==typeof define&&define.amd?define(["axios","lodash/compact","lodash/isEqual","lodash/isEmpty"],t):e.LayerManager=t(e.axios,e.compact,e.isEqual,e.isEmpty)}(this,function(d,s,r,l){"use strict";var n="default"in d?d.default:d;s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r,l=l&&l.hasOwnProperty("default")?l.default:l;function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var e=function(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),e};function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t){var i=1<arguments.length&&void 0!==t?t:{};return n.get(e,m({headers:c},i))}function a(e,t){var i=1<arguments.length&&void 0!==t?t:{},n=e;return Object.keys(i).forEach(function(e){n=n.replace(new RegExp("{{"+e+"}}","g"),i[e]).replace(new RegExp("{"+e+"}","g"),i[e])}),n}function u(e,t){var n=1<arguments.length&&void 0!==t?t:{},r=e,o=void 0;return Object.keys(n).forEach(function(i){o=(o=""+s(Object.keys(n[i]).map(function(e){var t=n[i][e];return Array.isArray(t)&&t.length?e+" IN ("+t.map(function(e){return"number"!=typeof e?"'"+e+"'":e}).join(", ")+")":!Array.isArray(t)&&t?"number"!=typeof t?e+" = '"+t+"'":e+" = "+t:null})).join(" AND "))&&i.startsWith("where")?"WHERE "+o:o&&i.startsWith("and")?"AND "+o:"",r=(r=r.replace(new RegExp("{{"+i+"}}","g"),o)).replace(new RegExp("{"+i+"}","g"),o)}),r}function y(e,t,i){var n=2<arguments.length&&void 0!==i?i:{},r=e;return"string"==typeof r&&(r=a(r,1<arguments.length&&void 0!==t?t:{}),r=u(r,n)),r}function t(a){if(!h)throw new Error("Leaflet must be defined.");var e=a.layerConfig,t=a.params,i=a.sqlParams,u=a.interactivity;return!1===e.parse||JSON.parse(y(JSON.stringify(e),t,i)),new Promise(function(s,t){(function(e){var t=e.layerConfig,i=e.params,n=e.sqlParams,r=e.interactivity,o=!1===t.parse?t:JSON.parse(y(JSON.stringify(t),i,n)),s=JSON.stringify({version:"1.3.0",stat_tag:"API",layers:o.body.layers.map(function(e){return r&&r.length?m({},e,{options:m({},e.options,{interactivity:r.split(", ")})}):e})}),a="?stat_tag=API&config="+encodeURIComponent(s),u="https://"+o.account+"-cdn.resilienceatlas.org/user/ra/api/v1/map"+a,c=e.layerRequest;c&&c.cancel("Operation canceled by the user.");var l=d.CancelToken.source();return e.set("layerRequest",l),f(u,{cancelToken:l.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})})(a).then(function(e){var t="https://"+e.cdn_url.https+"/ra/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png",i=h.tileLayer(t);if(u&&u.length){var n="https://"+e.cdn_url.https+"/ra/api/v1/map/"+e.layergroupid+"/0/{z}/{x}/{y}.grid.json",r=h.utfGrid(n),o=h.LayerGroup.extend({group:!0,setOpacity:function(t){a.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});return s(new o([i,r]))}return s(i)}).catch(function(e){return t(e)})})}var m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},c={"Content-Type":"application/json"},h=("undefined"!=typeof window?window:{}).L;t.getBounds=function(t){if(!h)throw new Error("Leaflet must be defined.");return new Promise(function(s,e){(function(e){var t=e.layerConfig,i=e.params,n=e.sqlParams,r=e.type,o=e.sql;"raster"===r&&(o="SELECT ST_Union(ST_Transform(ST_Envelope(the_raster_webmercator), 4326)) as the_geom FROM ("+o+") as t");var s="\n    SELECT ST_XMin(ST_Extent(the_geom)) as minx,\n    ST_YMin(ST_Extent(the_geom)) as miny,\n    ST_XMax(ST_Extent(the_geom)) as maxx,\n    ST_YMax(ST_Extent(the_geom)) as maxy\n    from ("+o+") as subq\n  ",a="https://"+(!1===t.parse?t:JSON.parse(y(JSON.stringify(t),i,n))).account+"-cdn.resilienceatlas.org/user/ra/api/v2/sql?q="+s.replace(/\n/g," "),u=e.boundsRequest;u&&u.cancel("Operation canceled by the user.");var c=d.CancelToken.source();return e.set("boundsRequest",c),f(a,{cancelToken:c.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})})(t).then(function(e){var t=e.rows[0],i=t.maxy,n=t.maxx,r=t.miny,o=t.minx;return s([[i,n],[r,o]])}).catch(e)})};var v=("undefined"!=typeof window?window:{}).L,p=v&&v.GridLayer.extend({tiles:{},createTile:function(e,t){for(var i=this,n=e.x,r=e.y,o=e.z,s=this.options.params,a=y(s.url,m({x:n,y:r,z:o},s)),u=Object.keys(this.tiles),c=0;c<u.length;c++)this.tiles[u[c]].z!==o&&delete this.tiles[u[c]];this.done=t;var l=v.DomUtil.create("canvas","leaflet-tile"),h=l.getContext("2d"),p=this.getTileSize();return l.width=p.x,l.height=p.y,this.getTile({x:n,y:r,z:o}).then(function(e){i.cacheTile(m({id:a,tile:l,ctx:h,image:e},{x:n,y:r,z:o})),i.drawCanvas(a),t(null,l)}).catch(function(e){t(e,l)}),l},getTile:function(e){var t=this,i=e.x,n=e.y,r=e.z,o=this.options,s=o.params,a=o.sqlParams,u=s.url,c=s.dataMaxZoom,l=void 0===c?20:c,h=r-l,p=y(s.url,m({x:i,y:n,z:r},s)),d={x:i,y:n,z:r};0<h&&(d={x:Math.floor(i/Math.pow(2,h)),y:Math.floor(n/Math.pow(2,h)),z:l});var f=y(u,m({},d,s),a);return new Promise(function(r,o){t.tiles[p]&&r(t.tiles[p].image);var e=new XMLHttpRequest;e.addEventListener("load",function(e){var t=e.currentTarget.response,i=URL.createObjectURL(t),n=new Image;n.src=i,n.onload=function(){n.crossOrigin="",r(n),URL.revokeObjectURL(i)},n.onerror=function(){o(new Error("Can't load image"))}}),e.addEventListener("error",o),e.open("GET",f,!0),e.responseType="blob",e.send()})},cacheTile:function(e){this.tiles[e.id]=m({},this.tiles[e.id],e)},drawCanvas:function(e){"use asm";if(!this.tiles[e]){return}var t=this.tiles[e],i=t.tile,n=t.ctx,r=t.image,o=t.x,s=t.y,a=t.z;if(!i||!n||!r||typeof o==="undefined"||typeof s==="undefined"||typeof a==="undefined"){delete this.tiles[e];return}var u=this.options,c=u.params,l=u.decodeParams,h=u.decodeFunction;var p=c.dataMaxZoom,d=p===undefined?20:p;var f=a-d;n.clearRect(0,0,i.width,i.width);if(f<0){n.drawImage(r,0,0)}else{n.imageSmoothingEnabled=false;n.mozImageSmoothingEnabled=false;var y=i.width/Math.pow(2,f)*(o%Math.pow(2,f))||0;var m=i.height/Math.pow(2,f)*(s%Math.pow(2,f))||0;var v=i.width/Math.pow(2,f)||0;var g=i.height/Math.pow(2,f)||0;n.drawImage(r,y,m,v,g,0,0,i.width,i.height)}var w=n.getImageData(0,0,i.width,i.height);if(typeof h==="function"){h(w.data,i.width,i.height,a,l)}n.putImageData(w,0,0)},reDraw:function(e){var s=this;this.options.params=e.params,this.options.sqlParams=e.sqlParams,this.options.decodeParams=e.decodeParams;var a=e.params,u=e.sqlParams;a&&a.url&&Object.keys(this.tiles).map(function(e){var t=s.tiles[e],i=t.x,n=t.y,r=t.z,o=y(a.url,m({x:i,y:n,z:r},a,{sqlParams:u}));return s.drawCanvas(o)})}});function g(e,t,i,n,r,o){if(!(r-n<=i)){var s=Math.floor((n+r)/2);!function e(t,i,n,r,o,s){for(;r<o;){if(600<o-r){var a=o-r+1,u=n-r+1,c=Math.log(a),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(a-l)/a)*(u-a/2<0?-1:1),p=Math.max(r,Math.floor(n-u*l/a+h)),d=Math.min(o,Math.floor(n+(a-u)*l/a+h));e(t,i,n,p,d,s)}var f=i[2*n+s],y=r,m=o;for(w(t,i,r,n),i[2*o+s]>f&&w(t,i,r,o);y<m;){for(w(t,i,y,m),y++,m--;i[2*y+s]<f;)y++;for(;i[2*m+s]>f;)m--}i[2*r+s]===f?w(t,i,r,m):w(t,i,++m,o),m<=n&&(r=m+1),n<=m&&(o=m-1)}}(e,t,s,n,r,o%2),g(e,t,i,n,s-1,o+1),g(e,t,i,s+1,r,o+1)}}function w(e,t,i,n){x(e,i,n),x(t,2*i,2*n),x(t,2*i+1,2*n+1)}function x(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function b(e,t,i,n){var r=e-i,o=t-n;return r*r+o*o}function L(e,t,i,n,r){return new O(e,t,i,n,r)}function O(e,t,i,n,r){t=t||P,i=i||E,r=r||Array,this.nodeSize=n||64,this.points=e,this.ids=new r(e.length),this.coords=new r(2*e.length);for(var o=0;o<e.length;o++)this.ids[o]=o,this.coords[2*o]=t(e[o]),this.coords[2*o+1]=i(e[o]);g(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function P(e){return e[0]}function E(e){return e[1]}function k(e){this.options=z(Object.create(this.options),e),this.trees=new Array(this.options.maxZoom+1)}function _(e){return{type:"Feature",id:e.id,properties:M(e),geometry:{type:"Point",coordinates:[function(e){return 360*(e-.5)}(e.x),function(e){var t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}(e.y)]}}}function M(e){var t=e.numPoints,i=1e4<=t?Math.round(t/1e3)+"k":1e3<=t?Math.round(t/100)/10+"k":t;return z(z({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:i})}function S(e){return e/360+.5}function C(e){var t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:1<i?1:i}function z(e,t){for(var i in t)e[i]=t[i];return e}function T(e){return e.x}function q(e){return e.y}k.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!(O.prototype={range:function(e,t,i,n){return function(e,t,i,n,r,o,s){for(var a,u,c=[0,e.length-1,0],l=[];c.length;){var h=c.pop(),p=c.pop(),d=c.pop();if(p-d<=s)for(var f=d;f<=p;f++)a=t[2*f],u=t[2*f+1],i<=a&&a<=r&&n<=u&&u<=o&&l.push(e[f]);else{var y=Math.floor((d+p)/2);a=t[2*y],u=t[2*y+1],i<=a&&a<=r&&n<=u&&u<=o&&l.push(e[y]);var m=(h+1)%2;(0===h?i<=a:n<=u)&&(c.push(d),c.push(y-1),c.push(m)),(0===h?a<=r:u<=o)&&(c.push(y+1),c.push(p),c.push(m))}}return l}(this.ids,this.coords,e,t,i,n,this.nodeSize)},within:function(e,t,i){return function(e,t,i,n,r,o){for(var s=[0,e.length-1,0],a=[],u=r*r;s.length;){var c=s.pop(),l=s.pop(),h=s.pop();if(l-h<=o)for(var p=h;p<=l;p++)b(t[2*p],t[2*p+1],i,n)<=u&&a.push(e[p]);else{var d=Math.floor((h+l)/2),f=t[2*d],y=t[2*d+1];b(f,y,i,n)<=u&&a.push(e[d]);var m=(c+1)%2;(0===c?i-r<=f:n-r<=y)&&(s.push(h),s.push(d-1),s.push(m)),(0===c?f<=i+r:y<=n+r)&&(s.push(d+1),s.push(l),s.push(m))}}return a}(this.ids,this.coords,e,t,i,this.nodeSize)}}),reduce:null,initial:function(){return{}},map:function(e){return e}},load:function(e){var t=this.options.log;t&&console.time("total time");var i="prepare "+e.length+" points";t&&console.time(i),this.points=e;for(var n,r,o,s=[],a=0;a<e.length;a++)e[a].geometry&&s.push((n=e[a],r=a,void 0,{x:S((o=n.geometry.coordinates)[0]),y:C(o[1]),zoom:1/0,index:r,parentId:-1}));this.trees[this.options.maxZoom+1]=L(s,T,q,this.options.nodeSize,Float32Array),t&&console.timeEnd(i);for(var u=this.options.maxZoom;u>=this.options.minZoom;u--){var c=+Date.now();s=this._cluster(s,u),this.trees[u]=L(s,T,q,this.options.nodeSize,Float32Array),t&&console.log("z%d: %d clusters in %dms",u,s.length,+Date.now()-c)}return t&&console.timeEnd("total time"),this},getClusters:function(e,t){var i=((e[0]+180)%360+360)%360-180,n=Math.max(-90,Math.min(90,e[1])),r=180===e[2]?180:((e[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,e[3]));if(360<=e[2]-e[0])i=-180,r=180;else if(r<i){var s=this.getClusters([i,n,180,o],t),a=this.getClusters([-180,n,r,o],t);return s.concat(a)}for(var u=this.trees[this._limitZoom(t)],c=u.range(S(i),C(o),S(r),C(n)),l=[],h=0;h<c.length;h++){var p=u.points[c[h]];l.push(p.numPoints?_(p):this.points[p.index])}return l},getChildren:function(e){var t=e>>5,i=e%32,n="No cluster with the specified id.",r=this.trees[i];if(!r)throw new Error(n);var o=r.points[t];if(!o)throw new Error(n);for(var s=this.options.radius/(this.options.extent*Math.pow(2,i-1)),a=r.within(o.x,o.y,s),u=[],c=0;c<a.length;c++){var l=r.points[a[c]];l.parentId===e&&u.push(l.numPoints?_(l):this.points[l.index])}if(0===u.length)throw new Error(n);return u},getLeaves:function(e,t,i){t=t||10,i=i||0;var n=[];return this._appendLeaves(n,e,t,i,0),n},getTile:function(e,t,i){var n=this.trees[this._limitZoom(e)],r=Math.pow(2,e),o=this.options.extent,s=this.options.radius/o,a=(i-s)/r,u=(i+1+s)/r,c={features:[]};return this._addTileFeatures(n.range((t-s)/r,a,(t+1+s)/r,u),n.points,t,i,r,c),0===t&&this._addTileFeatures(n.range(1-s/r,a,1,u),n.points,r,i,r,c),t===r-1&&this._addTileFeatures(n.range(0,a,s/r,u),n.points,-1,i,r,c),c.features.length?c:null},getClusterExpansionZoom:function(e){for(var t=e%32-1;t<this.options.maxZoom;){var i=this.getChildren(e);if(t++,1!==i.length)break;e=i[0].properties.cluster_id}return t},_appendLeaves:function(e,t,i,n,r){for(var o=this.getChildren(t),s=0;s<o.length;s++){var a=o[s].properties;if(a&&a.cluster?r+a.point_count<=n?r+=a.point_count:r=this._appendLeaves(e,a.cluster_id,i,n,r):r<n?r++:e.push(o[s]),e.length===i)break}return r},_addTileFeatures:function(e,t,i,n,r,o){for(var s=0;s<e.length;s++){var a=t[e[s]],u={type:1,geometry:[[Math.round(this.options.extent*(a.x*r-i)),Math.round(this.options.extent*(a.y*r-n))]],tags:a.numPoints?M(a):this.points[a.index].properties},c=a.numPoints?a.id:this.points[a.index].id;void 0!==c&&(u.id=c),o.features.push(u)}},_limitZoom:function(e){return Math.max(this.options.minZoom,Math.min(e,this.options.maxZoom+1))},_cluster:function(e,t){for(var i=[],n=this.options.radius/(this.options.extent*Math.pow(2,t)),r=0;r<e.length;r++){var o=e[r];if(!(o.zoom<=t)){o.zoom=t;var s=this.trees[t+1],a=s.within(o.x,o.y,n),u=o.numPoints||1,c=o.x*u,l=o.y*u,h=null;this.options.reduce&&(h=this.options.initial(),this._accumulate(h,o));for(var p=(r<<5)+(t+1),d=0;d<a.length;d++){var f=s.points[a[d]];if(!(f.zoom<=t)){f.zoom=t;var y=f.numPoints||1;c+=f.x*y,l+=f.y*y,u+=y,f.parentId=p,this.options.reduce&&this._accumulate(h,f)}}1===u?i.push(o):(o.parentId=p,i.push({x:c/u,y:l/u,zoom:1/0,id:p,parentId:-1,numPoints:u,properties:h}))}}return i},_accumulate:function(e,t){var i=t.numPoints?t.properties:this.options.map(this.points[t.index].properties);this.options.reduce(e,i)}};function I(e){if(!J)throw new Error("Leaflet must be defined.");var t=e.layerConfig,i=e.params,n=e.sqlParams,r=e.decodeParams,o=e.interactivity,s=void 0,a=!1===t.parse?t:JSON.parse(y(JSON.stringify(t),i,n));switch(a.body.crs&&J.CRS[a.body.crs]&&(a.body.crs=J.CRS[a.body.crs.replace(":","")],a.body.pane="tilePane"),a.type){case"wms":s=J.tileLayer.wms(a.url||a.body.url,a.body);break;case"tileLayer":if(0<=JSON.stringify(a.body).indexOf('style: "function')&&(a.body.style=B("("+a.body.style+")")),s=r&&a.canvas?new p(m({},e)):J.tileLayer(a.url||a.body.url,a.body),o){var u=new R,c=J.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});s=new c([s,u])}break;case"cluster":0<=JSON.stringify(a.body).indexOf('style: "function')&&(a.body.style=B("("+a.body.style+")")),s=new N(e);break;default:s=J[a.type](a.body,a.options||{})}return new Promise(function(e,t){s?e(s):t(new Error('"type" specified in layer spec doesn`t exist'))})}var j=("undefined"!=typeof window?window:{}).L,Z={50:25,100:30,1e3:40},N=j&&j.GeoJSON.extend({initialize:function(e){var i=this,t=this;j.GeoJSON.prototype.initialize.call(this,[]);var n=e.layerConfig,r=e.events,o=e.decodeClusters;if(o){var s=e.layerConfig||{},a=s.html,u=s.sizes,c=void 0===u?Z:u,l=s.clusterIcon,h=s.icon;j.Util.setOptions(this,{pointToLayer:function(e,t){if(!(e.properties&&e.properties.cluster))return j.marker(t,{icon:j.icon(m({iconSize:[35,35]},h))});var i=e.properties.point_count,n=null;if("function"==typeof c)n=function(){return c(i)};else{var r=Object.keys(c).find(function(e){return i<=parseInt(e,10)}),o=c[r];n=j.point(o,o)}return j.marker(t,{icon:j.divIcon(m({iconSize:n,html:a&&"function"==typeof a?a(e):'<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; '+(l.color?"background-color: "+l.color+";":"")+'">'+e.properties.point_count_abbreviated+"</div>"},l))})},onEachFeature:function(i,e){i.properties&&i.properties.cluster?e.on({click:function(){return t.setMapView(i)}}):r&&e.on(Object.keys(r).reduce(function(e,t){return m({},e,function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}({},t,function(e){return r[t](m({},e,{data:i.properties}))}))},{}))}});var p=(n||{}).clusterConfig;this.supercluster=function(e){return new k(e)}(m({radius:80,maxZoom:16},p)),function(e){var t=e.layerConfig,i=e.layerRequest,n=t.body.url;i&&i.cancel("Operation canceled by the user.");var r=d.CancelToken.source();return e.set("layerRequest",r),f(n,{cancelToken:r.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})}(e).then(function(e){var t=o(e);i.supercluster.load(t),i.update()})}else console.warn("You must provide a decodeClusters function")},setMapView:function(e){var t=e.geometry.coordinates,i=this.supercluster.getClusterExpansionZoom(e.properties.cluster_id);this._map.setView(t.reverse(),i)},onAdd:function(e){j.GeoJSON.prototype.onAdd.call(this,e),e.on("moveend zoomend",this.onMove,this)},onRemove:function(e){e.off("moveend zoomend",this.onMove,this),this.clear()},onMove:function(){this.clear(),this.update()},update:function(){var e=this._map.getZoom(),t=this._map.getBounds(),i=[t._southWest.lng,t._southWest.lat,t._northEast.lng,t._northEast.lat],n=this.supercluster.getClusters(i,e);this.addData(n)},clear:function(){j.GeoJSON.prototype.clearLayers.call(this,[])}}),A=("undefined"!=typeof window?window:{}).L,R=A&&A.GridLayer.extend({tiles:{},cache:{},mouseOn:null,createTile:function(e){for(var t=e.z,i=Object.keys(this.tiles),n=0;n<i.length;n++)this.tiles[i[n]].z!==t&&delete this.tiles[i[n]];var r=A.DomUtil.create("div","leaflet-tile"),o=this.getTileSize();return r.width=o.x,r.height=o.y,r},onAdd:function(e){A.GridLayer.prototype.onAdd.call(this,e),this.map=e;var t=Math.round(this.map.getZoom());t>this.options.maxZoom||t<this.options.minZoom||(e.on("click",this.click,this),e.on("mousemove",this.move,this))},onRemove:function(){var e=this.map;e.off("click",this.click,this),e.off("mousemove",this.move,this)},click:function(e){this.fire("click",this.objectForEvent(e))},move:function(e){var t=this.objectForEvent(e);t.data!==this.mouseOn?(this.mouseOn&&this.fire("mouseout",{latlng:e.latlng,data:this.mouseOn}),t.data&&this.fire("mouseover",t),this.mouseOn=t.data):t.data&&this.fire("mousemove",t)},objectForEvent:function(e){return A.extend({latlng:e.latlng,data:null},e)}}),J=("undefined"!=typeof window?window:{}).L,B=eval;I.getBounds=function(e){if(!J)throw new Error("Leaflet must be defined.");var t=e.layerConfig,i=e.params,n=e.sqlParams,r=(!1===t.parse?t:JSON.parse(y(JSON.stringify(t),i,n))).bbox;return new Promise(function(e){r?e([[r[1],r[0]],[r[3],r[2]]]):e(null)})};function D(s){if(!V)throw new Error("Leaflet must be defined.");if(!V.esri)throw new Error("To support this layer you should add esri library for Leaflet.");var e=s.layerConfig,a=s.interactivity,t=s.params,i=s.sqlParams,u=!1===e.parse?e:JSON.parse(y(JSON.stringify(e),t,i)),c=JSON.stringify(u.body||{}).replace(/"mosaic-rule":/g,'"mosaicRule":').replace(/"mosaic_rule":/g,'"mosaicRule":').replace(/"use-cors":/g,'"useCors":').replace(/"use_cors":/g,'"useCors":');return V[u.type]?new I(m({},s)):new Promise(function(e,t){if(!V.esri[u.type])return t(new Error('"type" specified in layer spec doesn`t exist'));var i=JSON.parse(c);i.pane="tilePane",i.useCors=!0,i.style&&0<=i.style.indexOf("function")&&(i.style=W("("+i.style+")"));var n=void 0;if(!(n=V.esri[u.type](i)))return t();if(n.on("load",function(){n.setZIndex(s.zIndex)}),n.on("requesterror",function(e){return console.error(e)}),n.setZIndex||(n.setZIndex=function(e){n._currentImage&&(n._currentImage._image.style.zIndex=e)}),a){var r=new R,o=V.LayerGroup.extend({group:!0,setOpacity:function(t){s.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});n=new o([n,r])}return e(n)})}function F(e){if(!X)throw new Error("Leaflet must be defined.");var t=e.id,i=e.layerConfig,n=e.interactivity,r=e.params,o=e.sqlParams,s=e.decodeParams,a="https://api.resourcewatch.org/v1/layer/"+t+"/tile/gee/{z}/{x}/{y}",u=!1===i.parse?i:JSON.parse(y(JSON.stringify(i),r,o)),c=void 0;switch(u.type){case"tileLayer":c=s?new p(m({},e)):X.tileLayer(a,u.body);break;default:c=X.tileLayer(a,u.body)}if(n){var l=new R,h=X.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});c=new h([c,l])}return new Promise(function(e,t){c?e(c):t(new Error('"type" specified in layer spec doesn`t exist'))})}function G(e){var t=e.id,i=e.layerConfig,n=e.interactivity,r=(i.period||{}).value||"1971",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/loca/{z}/{x}/{y}?year="+new Date(r).toISOString(),s=Y.tileLayer(o,m({},i.body,{minNativeZoom:4,bounds:H}));if(n){var a=new R,u=Y.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});s=new u([s,a])}return new Promise(function(e){e(s)})}function U(e){var t=e.id,i=e.layerConfig,n=e.interactivity,r=(i.period||{}).value||"1971-01-01",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/nexgddp/{z}/{x}/{y}?year="+new Date(r).toISOString(),s=K.tileLayer(o,i.body);if(n){var a=new R,u=K.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});s=new u([s,a])}return new Promise(function(e){e(s)})}var V=("undefined"!=typeof window?window:{}).L,W=eval,X=("undefined"!=typeof window?window:{}).L,Y=("undefined"!=typeof window?window:{}).L,H=Y&&new Y.LatLngBounds(new Y.LatLng(49.496674527470454,-66.357421875),new Y.LatLng(24.607069137709683,-131.66015625)),K=("undefined"!=typeof window?window:{}).L,Q=(e($,[{key:"add",value:function(e){var t=e.mapLayer;this.map.addLayer(t)}},{key:"remove",value:function(e){var i=e.mapLayer,t=e.events;t&&i&&Object.keys(t).forEach(function(t){i.group?i.eachLayer(function(e){e.off(t)}):i.off(t)}),i&&this.map.removeLayer(i)}},{key:"getLayerByProvider",value:function(e){return this.method[e]}},{key:"getLayerBoundsByProvider",value:function(e){return this.method[e].getBounds}},{key:"setZIndex",value:function(e,t){return e.mapLayer.setZIndex(t),this}},{key:"setOpacity",value:function(e,t){var i=e.mapLayer;return"function"==typeof i.setOpacity&&i.setOpacity(t),"function"==typeof i.setStyle&&i.setStyle({opacity:t}),this}},{key:"setVisibility",value:function(e,t){var i=e.opacity;this.setOpacity(e,t?i:0)}},{key:"setParams",value:function(e){this.remove(e)}},{key:"setLayerConfig",value:function(e){this.remove(e)}},{key:"setDecodeParams",value:function(e){var t=e.mapLayer,i=e.params,n=e.sqlParams,r=e.decodeParams,o=e.decodeFunction;return t.reDraw({decodeParams:r,decodeFunction:o,params:i,sqlParams:n}),this}}]),$);function $(e){var r=this;i(this,$),this.events={},this.method={cartodb:t,carto:t,raster:t,arcgis:D,featureservice:D,mapservice:D,tileservice:D,esrifeatureservice:D,esrimapservice:D,esritileservice:D,gee:F,loca:G,nexgddp:U,leaflet:I,wms:I},this.setEvents=function(e){var i=e.mapLayer,n=e.events;return"cluster"!==e.layerConfig.type&&(r.events[e.id]&&Object.keys(r.events[e.id]).forEach(function(t){i.group?i.eachLayer(function(e){e.off(t)}):i.off(t)}),Object.keys(n).forEach(function(t){i.group?i.eachLayer(function(e){e.on(t,n[t])}):i.on(t,n[t])}),r.events[e.id]=n),r},this.fitMapToLayer=function(e){var t=e.get("mapLayerBounds");t&&r.map.fitBounds(t)},this.map=e}var ee=(e(te,[{key:"get",value:function(e){return this[e]}},{key:"set",value:function(e,t){return this[e]=t,this}},{key:"update",value:function(e){var t=this,i=m({},this),n=m({},e);this.set("changedAttributes",{}),Object.keys(n).forEach(function(e){r(i[e],n[e])||(t.changedAttributes[e]=n[e],t.set(e,n[e]))})}}]),te);function te(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};i(this,te),this.opacity=1,this.visibility=!0,Object.assign(this,e,{changedAttributes:{}})}var ie=(e(ne,[{key:"renderLayers",value:function(){var a=this;return 0<this.layers.length?(this.layers.forEach(function(e){var t=e.changedAttributes,i=t.sqlParams,n=t.params,r=t.layerConfig,o=0<Object.keys(t).length,s=i||n||r;if(!s){if(e.mapLayer&&!o)return!1;if(e.mapLayer&&o)return a.updateLayer(e)}return e.mapLayer&&s&&a.updateLayer(e),a.requestLayer(e),a.requestLayerBounds(e),e.set("changedAttributes",{})}),0===Object.keys(this.promises).length?Promise.resolve(this.layers):Promise.all(Object.values(this.promises)).then(function(){return a.layers}).then(function(){a.promises={}})):Promise.resolve(this.layers)}},{key:"add",value:function(e,t){var n=this,r=1<arguments.length&&void 0!==t?t:{opacity:1,visibility:!0,zIndex:0,interactivity:null};return void 0===e?(console.error("layers is required"),this):Array.isArray(e)?(e.forEach(function(t){var e=n.layers.find(function(e){return e.id===t.id}),i=m({},t,r);e?e.update(i):n.layers.push(new ee(i))}),this.layers):(console.error("layers should be an array"),this)}},{key:"updateLayer",value:function(e){var t=e.changedAttributes,i=t.opacity,n=t.visibility,r=t.zIndex,o=t.params,s=t.sqlParams,a=t.decodeParams,u=t.layerConfig,c=t.events;void 0!==i&&this.plugin.setOpacity(e,i),void 0!==n&&this.plugin.setOpacity(e,n?e.opacity:0),void 0!==r&&this.plugin.setZIndex(e,r),void 0!==c&&this.setEvents(e),l(u)||this.plugin.setLayerConfig(e),l(o)||this.plugin.setParams(e),l(s)||this.plugin.setParams(e),l(a)||this.plugin.setDecodeParams(e)}},{key:"remove",value:function(e){var i=this,n=this.layers.slice(0),r=Array.isArray(e)?e:[e];this.layers.forEach(function(e,t){r?r.includes(e.id)&&(i.plugin.remove(e),n.splice(t,1)):i.plugin.remove(e)}),this.layers=r?n:[]}},{key:"setOpacity",value:function(t,i){var n=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){n.plugin.setOpacity(e,i)}):console.error("Can't find the layer")}},{key:"setVisibility",value:function(t,i){var n=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){n.plugin.setVisibility(e,i)}):console.error("Can't find the layer")}},{key:"setZIndex",value:function(t,i){var n=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){n.plugin.setZIndex(e,i)}):console.error("Can't find the layer")}},{key:"setEvents",value:function(e){e.events&&this.plugin.setEvents(e)}},{key:"fitMapToLayer",value:function(t){if("function"==typeof this.plugin.fitMapToLayer){var e=this.layers.find(function(e){return e.id===t});e&&this.plugin.fitMapToLayer(e)}else console.error("This plugin does not support fitting map bounds to layer yet.")}},{key:"requestLayer",value:function(t){var i=this,e=t.provider,n=this.plugin.getLayerByProvider(e);return n?(this.promises[t.id]&&this.promises[t.id].isPending&&this.promises[t.id].isPending()&&this.promises[t.id].cancel(),this.promises[t.id]=n.call(this,t).then(function(e){t.set("mapLayer",e),i.plugin.add(t),i.plugin.setZIndex(t,t.zIndex),i.plugin.setOpacity(t,t.opacity),i.plugin.setVisibility(t,t.visibility),i.setEvents(t)}),this):(this.promises[t.id]=Promise.reject(new Error(e+" provider is not yet supported.")),!1)}},{key:"requestLayerBounds",value:function(t){var e=t.provider,i=this.plugin.getLayerBoundsByProvider(e);if(!i)return!1;var n=t.id+"_bounds";return this.promises[n]&&this.promises[n].isPending&&this.promises[n].isPending()&&this.promises[n].cancel(),this.promises[n]=i.call(this,t).then(function(e){t.set("mapLayerBounds",e)}),this}}]),ne);function ne(e,t){i(this,ne),this.map=e,this.plugin=new t(this.map),function(t){if(t){["add","remove","setVisibility","setOpacity","setEvents","setZIndex","setLayerConfig","setParams","setDecodeParams","getLayerByProvider"].forEach(function(e){t[e]||console.error("The "+e+" function is required for layer manager plugins")})}}(this.plugin),this.layers=[],this.promises={}}return ie.PluginLeaflet=Q,ie.replace=y,ie.substitution=a,ie.concatenation=u,ie});
