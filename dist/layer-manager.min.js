!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("lodash/compact"),require("lodash/isEqual"),require("lodash/isEmpty"),require("lodash/debounce")):"function"==typeof define&&define.amd?define(["axios","lodash/compact","lodash/isEqual","lodash/isEmpty","lodash/debounce"],t):e.LayerManager=t(e.axios,e.compact,e.isEqual,e.isEmpty,e.debounce)}(this,function(d,s,r,l,i){"use strict";var o="default"in d?d.default:d;s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r,l=l&&l.hasOwnProperty("default")?l.default:l,i=i&&i.hasOwnProperty("default")?i.default:i;function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var e=function(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e};function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t){var n=1<arguments.length&&void 0!==t?t:{};return o.get(e,m({headers:p},n))}function c(e,t){var n=1<arguments.length&&void 0!==t?t:{},i=e;return Object.keys(n).forEach(function(e){i=i.replace(new RegExp("{{"+e+"}}","g"),n[e]).replace(new RegExp("{"+e+"}","g"),n[e])}),i}function h(e,t){var i=1<arguments.length&&void 0!==t?t:{},r=e,o=void 0;return Object.keys(i).forEach(function(n){o=(o=""+s(Object.keys(i[n]).map(function(e){var t=i[n][e];return Array.isArray(t)&&t.length?e+" IN ("+t.map(function(e){return"number"!=typeof e?"'"+e+"'":e}).join(", ")+")":!Array.isArray(t)&&t?"number"!=typeof t?e+" = '"+t+"'":e+" = "+t:null})).join(" AND "))&&n.startsWith("where")?"WHERE "+o:o&&n.startsWith("and")?"AND "+o:"",r=(r=r.replace(new RegExp("{{"+n+"}}","g"),o)).replace(new RegExp("{"+n+"}","g"),o)}),r}function y(e,t,n){var i=2<arguments.length&&void 0!==n?n:{},r=e;return"string"==typeof r&&(r=c(r,1<arguments.length&&void 0!==t?t:{}),r=h(r,i)),r}function t(a){if(!v)throw new Error("Leaflet must be defined.");var e=a.layerConfig,t=a.params,n=a.sqlParams,u=a.interactivity;return!1===e.parse||JSON.parse(y(JSON.stringify(e),t,n)),new Promise(function(s,t){(function(e){var t=e.layerConfig,n=e.params,i=e.sqlParams,r=e.interactivity,o=!1===t.parse?t:JSON.parse(y(JSON.stringify(t),n,i)),s=JSON.stringify({version:"1.3.0",stat_tag:"API",layers:o.body.layers.map(function(e){return r&&r.length?m({},e,{options:m({},e.options,{interactivity:r.split(", ")})}):e})}),a="?stat_tag=API&config="+encodeURIComponent(s),u="https://"+o.account+"-cdn.resilienceatlas.org/user/ra/api/v1/map"+a,c=e.layerRequest;c&&c.cancel("Operation canceled by the user.");var l=d.CancelToken.source();return e.set("layerRequest",l),f(u,{cancelToken:l.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})})(a).then(function(e){var t="https://"+e.cdn_url.https+"/ra/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png",n=v.tileLayer(t);if(u&&u.length){var i="https://"+e.cdn_url.https+"/ra/api/v1/map/"+e.layergroupid+"/0/{z}/{x}/{y}.grid.json",r=v.utfGrid(i),o=v.LayerGroup.extend({group:!0,setOpacity:function(t){a.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});return s(new o([n,r]))}return s(n)}).catch(function(e){return t(e)})})}var m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},p={"Content-Type":"application/json"},v=("undefined"!=typeof window?window:{}).L;t.getBounds=function(t){if(!v)throw new Error("Leaflet must be defined.");return new Promise(function(s,e){(function(e){var t=e.layerConfig,n=e.params,i=e.sqlParams,r=e.type,o=e.sql;"raster"===r&&(o="SELECT ST_Union(ST_Transform(ST_Envelope(the_raster_webmercator), 4326)) as the_geom FROM ("+o+") as t");var s="\n    SELECT ST_XMin(ST_Extent(the_geom)) as minx,\n    ST_YMin(ST_Extent(the_geom)) as miny,\n    ST_XMax(ST_Extent(the_geom)) as maxx,\n    ST_YMax(ST_Extent(the_geom)) as maxy\n    from ("+o+") as subq\n  ",a="https://"+(!1===t.parse?t:JSON.parse(y(JSON.stringify(t),n,i))).account+"-cdn.resilienceatlas.org/user/ra/api/v2/sql?q="+s.replace(/\n/g," "),u=e.boundsRequest;u&&u.cancel("Operation canceled by the user.");var c=d.CancelToken.source();return e.set("boundsRequest",c),f(a,{cancelToken:c.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})})(t).then(function(e){var t=e.rows[0],n=t.maxy,i=t.maxx,r=t.miny,o=t.minx;return s([[n,i],[r,o]])}).catch(e)})};var g=("undefined"!=typeof window?window:{}).L,w=g&&g.GridLayer.extend({tiles:{},createTile:function(e,t){for(var n=this,i=e.x,r=e.y,o=e.z,s=this.options.params,a=y(s.url,m({x:i,y:r,z:o},s)),u=Object.keys(this.tiles),c=0;c<u.length;c++)this.tiles[u[c]].z!==o&&delete this.tiles[u[c]];this.done=t;var l=g.DomUtil.create("canvas","leaflet-tile"),h=l.getContext("2d"),p=this.getTileSize();return l.width=p.x,l.height=p.y,this.getTile({x:i,y:r,z:o}).then(function(e){n.cacheTile(m({id:a,tile:l,ctx:h,image:e},{x:i,y:r,z:o})),n.drawCanvas(a),t(null,l)}).catch(function(e){t(e,l)}),l},getTile:function(e){var t=this,n=e.x,i=e.y,r=e.z,o=this.options,s=o.params,a=o.sqlParams,u=s.url,c=s.dataMaxZoom,l=void 0===c?20:c,h=r-l,p=y(s.url,m({x:n,y:i,z:r},s)),d={x:n,y:i,z:r};0<h&&(d={x:Math.floor(n/Math.pow(2,h)),y:Math.floor(i/Math.pow(2,h)),z:l});var f=y(u,m({},d,s),a);return new Promise(function(r,o){t.tiles[p]&&r(t.tiles[p].image);var e=new XMLHttpRequest;e.addEventListener("load",function(e){var t=e.currentTarget.response,n=URL.createObjectURL(t),i=new Image;i.src=n,i.onload=function(){i.crossOrigin="",r(i),URL.revokeObjectURL(n)},i.onerror=function(){o(new Error("Can't load image"))}}),e.addEventListener("error",o),e.open("GET",f,!0),e.responseType="blob",e.send()})},cacheTile:function(e){this.tiles[e.id]=m({},this.tiles[e.id],e)},drawCanvas:function(e){"use asm";if(!this.tiles[e]){return}var t=this.tiles[e],n=t.tile,i=t.ctx,r=t.image,o=t.x,s=t.y,a=t.z;if(!n||!i||!r||typeof o==="undefined"||typeof s==="undefined"||typeof a==="undefined"){delete this.tiles[e];return}var u=this.options,c=u.params,l=u.decodeParams,h=u.decodeFunction;var p=c.dataMaxZoom,d=p===undefined?20:p;var f=a-d;i.clearRect(0,0,n.width,n.width);if(f<0){i.drawImage(r,0,0)}else{i.imageSmoothingEnabled=false;i.mozImageSmoothingEnabled=false;var y=n.width/Math.pow(2,f)*(o%Math.pow(2,f))||0;var m=n.height/Math.pow(2,f)*(s%Math.pow(2,f))||0;var v=n.width/Math.pow(2,f)||0;var g=n.height/Math.pow(2,f)||0;i.drawImage(r,y,m,v,g,0,0,n.width,n.height)}var w=i.getImageData(0,0,n.width,n.height);if(typeof h==="function"){h(w.data,n.width,n.height,a,l)}i.putImageData(w,0,0)},reDraw:function(e){var s=this;this.options.params=e.params,this.options.sqlParams=e.sqlParams,this.options.decodeParams=e.decodeParams;var a=e.params,u=e.sqlParams;a&&a.url&&Object.keys(this.tiles).map(function(e){var t=s.tiles[e],n=t.x,i=t.y,r=t.z,o=y(a.url,m({x:n,y:i,z:r},a,{sqlParams:u}));return s.drawCanvas(o)})}});function x(e,t,n,i,r,o){if(!(r-i<=n)){var s=Math.floor((i+r)/2);!function e(t,n,i,r,o,s){for(;r<o;){if(600<o-r){var a=o-r+1,u=i-r+1,c=Math.log(a),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(a-l)/a)*(u-a/2<0?-1:1),p=Math.max(r,Math.floor(i-u*l/a+h)),d=Math.min(o,Math.floor(i+(a-u)*l/a+h));e(t,n,i,p,d,s)}var f=n[2*i+s],y=r,m=o;for(b(t,n,r,i),n[2*o+s]>f&&b(t,n,r,o);y<m;){for(b(t,n,y,m),y++,m--;n[2*y+s]<f;)y++;for(;n[2*m+s]>f;)m--}n[2*r+s]===f?b(t,n,r,m):b(t,n,++m,o),m<=i&&(r=m+1),i<=m&&(o=m-1)}}(e,t,s,i,r,o%2),x(e,t,n,i,s-1,o+1),x(e,t,n,s+1,r,o+1)}}function b(e,t,n,i){L(e,n,i),L(t,2*n,2*i),L(t,2*n+1,2*i+1)}function L(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function O(e,t,n,i){var r=e-n,o=t-i;return r*r+o*o}function P(e,t,n,i,r){return new E(e,t,n,i,r)}function E(e,t,n,i,r){t=t||k,n=n||_,r=r||Array,this.nodeSize=i||64,this.points=e,this.ids=new r(e.length),this.coords=new r(2*e.length);for(var o=0;o<e.length;o++)this.ids[o]=o,this.coords[2*o]=t(e[o]),this.coords[2*o+1]=n(e[o]);x(this.ids,this.coords,this.nodeSize,0,this.ids.length-1,0)}function k(e){return e[0]}function _(e){return e[1]}function M(e){this.options=T(Object.create(this.options),e),this.trees=new Array(this.options.maxZoom+1)}function S(e){return{type:"Feature",id:e.id,properties:C(e),geometry:{type:"Point",coordinates:[function(e){return 360*(e-.5)}(e.x),function(e){var t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}(e.y)]}}}function C(e){var t=e.numPoints,n=1e4<=t?Math.round(t/1e3)+"k":1e3<=t?Math.round(t/100)/10+"k":t;return T(T({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:n})}function z(e){return e/360+.5}function q(e){var t=Math.sin(e*Math.PI/180),n=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return n<0?0:1<n?1:n}function T(e,t){for(var n in t)e[n]=t[n];return e}function I(e){return e.x}function j(e){return e.y}M.prototype={options:{minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,log:!(E.prototype={range:function(e,t,n,i){return function(e,t,n,i,r,o,s){for(var a,u,c=[0,e.length-1,0],l=[];c.length;){var h=c.pop(),p=c.pop(),d=c.pop();if(p-d<=s)for(var f=d;f<=p;f++)a=t[2*f],u=t[2*f+1],n<=a&&a<=r&&i<=u&&u<=o&&l.push(e[f]);else{var y=Math.floor((d+p)/2);a=t[2*y],u=t[2*y+1],n<=a&&a<=r&&i<=u&&u<=o&&l.push(e[y]);var m=(h+1)%2;(0===h?n<=a:i<=u)&&(c.push(d),c.push(y-1),c.push(m)),(0===h?a<=r:u<=o)&&(c.push(y+1),c.push(p),c.push(m))}}return l}(this.ids,this.coords,e,t,n,i,this.nodeSize)},within:function(e,t,n){return function(e,t,n,i,r,o){for(var s=[0,e.length-1,0],a=[],u=r*r;s.length;){var c=s.pop(),l=s.pop(),h=s.pop();if(l-h<=o)for(var p=h;p<=l;p++)O(t[2*p],t[2*p+1],n,i)<=u&&a.push(e[p]);else{var d=Math.floor((h+l)/2),f=t[2*d],y=t[2*d+1];O(f,y,n,i)<=u&&a.push(e[d]);var m=(c+1)%2;(0===c?n-r<=f:i-r<=y)&&(s.push(h),s.push(d-1),s.push(m)),(0===c?f<=n+r:y<=i+r)&&(s.push(d+1),s.push(l),s.push(m))}}return a}(this.ids,this.coords,e,t,n,this.nodeSize)}}),reduce:null,initial:function(){return{}},map:function(e){return e}},load:function(e){var t=this.options.log;t&&console.time("total time");var n="prepare "+e.length+" points";t&&console.time(n),this.points=e;for(var i,r,o,s=[],a=0;a<e.length;a++)e[a].geometry&&s.push((i=e[a],r=a,void 0,{x:z((o=i.geometry.coordinates)[0]),y:q(o[1]),zoom:1/0,index:r,parentId:-1}));this.trees[this.options.maxZoom+1]=P(s,I,j,this.options.nodeSize,Float32Array),t&&console.timeEnd(n);for(var u=this.options.maxZoom;u>=this.options.minZoom;u--){var c=+Date.now();s=this._cluster(s,u),this.trees[u]=P(s,I,j,this.options.nodeSize,Float32Array),t&&console.log("z%d: %d clusters in %dms",u,s.length,+Date.now()-c)}return t&&console.timeEnd("total time"),this},getClusters:function(e,t){var n=((e[0]+180)%360+360)%360-180,i=Math.max(-90,Math.min(90,e[1])),r=180===e[2]?180:((e[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,e[3]));if(360<=e[2]-e[0])n=-180,r=180;else if(r<n){var s=this.getClusters([n,i,180,o],t),a=this.getClusters([-180,i,r,o],t);return s.concat(a)}for(var u=this.trees[this._limitZoom(t)],c=u.range(z(n),q(o),z(r),q(i)),l=[],h=0;h<c.length;h++){var p=u.points[c[h]];l.push(p.numPoints?S(p):this.points[p.index])}return l},getChildren:function(e){var t=e>>5,n=e%32,i="No cluster with the specified id.",r=this.trees[n];if(!r)throw new Error(i);var o=r.points[t];if(!o)throw new Error(i);for(var s=this.options.radius/(this.options.extent*Math.pow(2,n-1)),a=r.within(o.x,o.y,s),u=[],c=0;c<a.length;c++){var l=r.points[a[c]];l.parentId===e&&u.push(l.numPoints?S(l):this.points[l.index])}if(0===u.length)throw new Error(i);return u},getLeaves:function(e,t,n){t=t||10,n=n||0;var i=[];return this._appendLeaves(i,e,t,n,0),i},getTile:function(e,t,n){var i=this.trees[this._limitZoom(e)],r=Math.pow(2,e),o=this.options.extent,s=this.options.radius/o,a=(n-s)/r,u=(n+1+s)/r,c={features:[]};return this._addTileFeatures(i.range((t-s)/r,a,(t+1+s)/r,u),i.points,t,n,r,c),0===t&&this._addTileFeatures(i.range(1-s/r,a,1,u),i.points,r,n,r,c),t===r-1&&this._addTileFeatures(i.range(0,a,s/r,u),i.points,-1,n,r,c),c.features.length?c:null},getClusterExpansionZoom:function(e){for(var t=e%32-1;t<this.options.maxZoom;){var n=this.getChildren(e);if(t++,1!==n.length)break;e=n[0].properties.cluster_id}return t},_appendLeaves:function(e,t,n,i,r){for(var o=this.getChildren(t),s=0;s<o.length;s++){var a=o[s].properties;if(a&&a.cluster?r+a.point_count<=i?r+=a.point_count:r=this._appendLeaves(e,a.cluster_id,n,i,r):r<i?r++:e.push(o[s]),e.length===n)break}return r},_addTileFeatures:function(e,t,n,i,r,o){for(var s=0;s<e.length;s++){var a=t[e[s]],u={type:1,geometry:[[Math.round(this.options.extent*(a.x*r-n)),Math.round(this.options.extent*(a.y*r-i))]],tags:a.numPoints?C(a):this.points[a.index].properties},c=a.numPoints?a.id:this.points[a.index].id;void 0!==c&&(u.id=c),o.features.push(u)}},_limitZoom:function(e){return Math.max(this.options.minZoom,Math.min(e,this.options.maxZoom+1))},_cluster:function(e,t){for(var n=[],i=this.options.radius/(this.options.extent*Math.pow(2,t)),r=0;r<e.length;r++){var o=e[r];if(!(o.zoom<=t)){o.zoom=t;var s=this.trees[t+1],a=s.within(o.x,o.y,i),u=o.numPoints||1,c=o.x*u,l=o.y*u,h=null;this.options.reduce&&(h=this.options.initial(),this._accumulate(h,o));for(var p=(r<<5)+(t+1),d=0;d<a.length;d++){var f=s.points[a[d]];if(!(f.zoom<=t)){f.zoom=t;var y=f.numPoints||1;c+=f.x*y,l+=f.y*y,u+=y,f.parentId=p,this.options.reduce&&this._accumulate(h,f)}}1===u?n.push(o):(o.parentId=p,n.push({x:c/u,y:l/u,zoom:1/0,id:p,parentId:-1,numPoints:u,properties:h}))}}return n},_accumulate:function(e,t){var n=t.numPoints?t.properties:this.options.map(this.points[t.index].properties);this.options.reduce(e,n)}};function Z(e){if(!B)throw new Error("Leaflet must be defined.");var t=e.layerConfig,n=e.params,i=e.sqlParams,r=e.decodeParams,o=e.interactivity,s=void 0,a=!1===t.parse?t:JSON.parse(y(JSON.stringify(t),n,i));switch(a.body.crs&&B.CRS[a.body.crs]&&(a.body.crs=B.CRS[a.body.crs.replace(":","")],a.body.pane="tilePane"),a.type){case"wms":s=B.tileLayer.wms(a.url||a.body.url,a.body);break;case"tileLayer":if(0<=JSON.stringify(a.body).indexOf('style: "function')&&(a.body.style=F("("+a.body.style+")")),s=r&&a.canvas?new w(m({},e)):B.tileLayer(a.url||a.body.url,a.body),o){var u=new D,c=B.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});s=new c([s,u])}break;case"cluster":0<=JSON.stringify(a.body).indexOf('style: "function')&&(a.body.style=F("("+a.body.style+")")),s=new R(e);break;default:s=B[a.type](a.body,a.options||{})}return new Promise(function(e,t){s?e(s):t(new Error('"type" specified in layer spec doesn`t exist'))})}var N=("undefined"!=typeof window?window:{}).L,A={50:25,100:30,1e3:40},R=N&&N.GeoJSON.extend({initialize:function(e){var n=this,t=this;N.GeoJSON.prototype.initialize.call(this,[]);var i=e.layerConfig,r=e.events,o=e.decodeClusters;if(o){var s=e.layerConfig||{},a=s.html,u=s.sizes,c=void 0===u?A:u,l=s.clusterIcon,h=s.icon;N.Util.setOptions(this,{pointToLayer:function(e,t){if(!(e.properties&&e.properties.cluster))return N.marker(t,{icon:N.icon(m({iconSize:[35,35]},h))});var n=e.properties.point_count,i=null;if("function"==typeof c)i=function(){return c(n)};else{var r=Object.keys(c).find(function(e){return n<=parseInt(e,10)}),o=c[r];i=N.point(o,o)}return N.marker(t,{icon:N.divIcon(m({iconSize:i,html:a&&"function"==typeof a?a(e):'<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; '+(l.color?"background-color: "+l.color+";":"")+'">'+e.properties.point_count_abbreviated+"</div>"},l))})},onEachFeature:function(n,e){n.properties&&n.properties.cluster?e.on({click:function(){return t.setMapView(n)}}):r&&e.on(Object.keys(r).reduce(function(e,t){return m({},e,function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}({},t,function(e){return r[t](m({},e,{data:n.properties}))}))},{}))}});var p=(i||{}).clusterConfig;this.supercluster=function(e){return new M(e)}(m({radius:80,maxZoom:16},p)),function(e){var t=e.layerConfig,n=e.layerRequest,i=t.body.url;n&&n.cancel("Operation canceled by the user.");var r=d.CancelToken.source();return e.set("layerRequest",r),f(i,{cancelToken:r.token}).then(function(e){return 400<e.status?(console.error(e),!1):e.data})}(e).then(function(e){var t=o(e);n.supercluster.load(t),n.update()})}else console.warn("You must provide a decodeClusters function")},setMapView:function(e){var t=e.geometry.coordinates,n=this.supercluster.getClusterExpansionZoom(e.properties.cluster_id);this._map.setView(t.reverse(),n)},onAdd:function(e){N.GeoJSON.prototype.onAdd.call(this,e),e.on("moveend zoomend",this.onMove,this)},onRemove:function(e){e.off("moveend zoomend",this.onMove,this),this.clear()},onMove:function(){this.clear(),this.update()},update:function(){var e=this._map.getZoom(),t=this._map.getBounds(),n=[t._southWest.lng,t._southWest.lat,t._northEast.lng,t._northEast.lat],i=this.supercluster.getClusters(n,e);this.addData(i)},clear:function(){N.GeoJSON.prototype.clearLayers.call(this,[])}}),J=("undefined"!=typeof window?window:{}).L,D=J&&J.GridLayer.extend({tiles:{},cache:{},mouseOn:null,createTile:function(e){for(var t=e.z,n=Object.keys(this.tiles),i=0;i<n.length;i++)this.tiles[n[i]].z!==t&&delete this.tiles[n[i]];var r=J.DomUtil.create("div","leaflet-tile"),o=this.getTileSize();return r.width=o.x,r.height=o.y,r},onAdd:function(e){J.GridLayer.prototype.onAdd.call(this,e),this.map=e;var t=Math.round(this.map.getZoom());t>this.options.maxZoom||t<this.options.minZoom||(e.on("click",this.click,this),e.on("mousemove",this.move,this))},onRemove:function(){var e=this.map;e.off("click",this.click,this),e.off("mousemove",this.move,this)},click:function(e){this.fire("click",this.objectForEvent(e))},move:function(e){var t=this.objectForEvent(e);t.data!==this.mouseOn?(this.mouseOn&&this.fire("mouseout",{latlng:e.latlng,data:this.mouseOn}),t.data&&this.fire("mouseover",t),this.mouseOn=t.data):t.data&&this.fire("mousemove",t)},objectForEvent:function(e){return J.extend({latlng:e.latlng,data:null},e)}}),B=("undefined"!=typeof window?window:{}).L,F=eval;Z.getBounds=function(e){if(!B)throw new Error("Leaflet must be defined.");var t=e.layerConfig,n=e.params,i=e.sqlParams,r=(!1===t.parse?t:JSON.parse(y(JSON.stringify(t),n,i))).bbox;return new Promise(function(e){r?e([[r[1],r[0]],[r[3],r[2]]]):e(null)})};function n(s){if(!W)throw new Error("Leaflet must be defined.");if(!W.esri)throw new Error("To support this layer you should add esri library for Leaflet.");var e=s.layerConfig,a=s.interactivity,t=s.params,n=s.sqlParams,u=!1===e.parse?e:JSON.parse(y(JSON.stringify(e),t,n)),c=JSON.stringify(u.body||{}).replace(/"mosaic-rule":/g,'"mosaicRule":').replace(/"mosaic_rule":/g,'"mosaicRule":').replace(/"use-cors":/g,'"useCors":').replace(/"use_cors":/g,'"useCors":');return W[u.type]?new Z(m({},s)):new Promise(function(e,t){if(!W.esri[u.type])return t(new Error('"type" specified in layer spec doesn`t exist'));var n=JSON.parse(c);n.pane="tilePane",n.useCors=!0,n.style&&0<=n.style.indexOf("function")&&(n.style=X("("+n.style+")"));var i=void 0;if(!(i=W.esri[u.type](n)))return t();if(i.on("load",function(){i.setZIndex(s.zIndex)}),i.on("requesterror",function(e){return console.error(e)}),i.setZIndex||(i.setZIndex=function(e){i._currentImage&&(i._currentImage._image.style.zIndex=e)}),a){var r=new D,o=W.LayerGroup.extend({group:!0,setOpacity:function(t){s.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});i=new o([i,r])}return e(i)})}function G(e){if(!Y)throw new Error("Leaflet must be defined.");var t=e.id,n=e.layerConfig,i=e.interactivity,r=e.params,o=e.sqlParams,s=e.decodeParams,a="https://api.resourcewatch.org/v1/layer/"+t+"/tile/gee/{z}/{x}/{y}",u=!1===n.parse?n:JSON.parse(y(JSON.stringify(n),r,o)),c=void 0;switch(u.type){case"tileLayer":c=s?new w(m({},e)):Y.tileLayer(a,u.body);break;default:c=Y.tileLayer(a,u.body)}if(i){var l=new D,h=Y.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});c=new h([c,l])}return new Promise(function(e,t){c?e(c):t(new Error('"type" specified in layer spec doesn`t exist'))})}function U(e){var t=e.id,n=e.layerConfig,i=e.interactivity,r=(n.period||{}).value||"1971",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/loca/{z}/{x}/{y}?year="+new Date(r).toISOString(),s=H.tileLayer(o,m({},n.body,{minNativeZoom:4,bounds:K}));if(i){var a=new D,u=H.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});s=new u([s,a])}return new Promise(function(e){e(s)})}function V(e){var t=e.id,n=e.layerConfig,i=e.interactivity,r=(n.period||{}).value||"1971-01-01",o="https://api.resourcewatch.org/v1/layer/"+t+"/tile/nexgddp/{z}/{x}/{y}?year="+new Date(r).toISOString(),s=Q.tileLayer(o,n.body);if(i){var a=new D,u=Q.LayerGroup.extend({group:!0,setOpacity:function(t){e.mapLayer.getLayers().forEach(function(e){e.setOpacity(t)})}});s=new u([s,a])}return new Promise(function(e){e(s)})}var W=("undefined"!=typeof window?window:{}).L,X=eval,Y=("undefined"!=typeof window?window:{}).L,H=("undefined"!=typeof window?window:{}).L,K=H&&new H.LatLngBounds(new H.LatLng(49.496674527470454,-66.357421875),new H.LatLng(24.607069137709683,-131.66015625)),Q=("undefined"!=typeof window?window:{}).L,$=(e(ee,[{key:"add",value:function(e){var t=e.mapLayer;this.map.addLayer(t)}},{key:"remove",value:function(e){var n=e.mapLayer,t=e.events;t&&n&&Object.keys(t).forEach(function(t){n.group?n.eachLayer(function(e){e.off(t)}):n.off(t)}),n&&this.map.removeLayer(n)}},{key:"getLayerByProvider",value:function(e){return this.method[e]}},{key:"getLayerBoundsByProvider",value:function(e){return this.method[e].getBounds}},{key:"setZIndex",value:function(e,t){return e.mapLayer.setZIndex(t),this}},{key:"setOpacity",value:function(e,t){var n=e.mapLayer;return"function"==typeof n.setOpacity&&n.setOpacity(t),"function"==typeof n.setStyle&&n.setStyle({opacity:t}),this}},{key:"setVisibility",value:function(e,t){var n=e.opacity;this.setOpacity(e,t?n:0)}},{key:"setParams",value:function(e){this.remove(e)}},{key:"setLayerConfig",value:function(e){this.remove(e)}},{key:"setDecodeParams",value:function(e){var t=e.mapLayer,n=e.params,i=e.sqlParams,r=e.decodeParams,o=e.decodeFunction;return t.group?t.eachLayer(function(e){e.reDraw&&e.reDraw({decodeParams:r,decodeFunction:o,params:n,sqlParams:i})}):t.reDraw({decodeParams:r,decodeFunction:o,params:n,sqlParams:i}),this}}]),ee);function ee(e){var r=this;a(this,ee),this.events={},this.method={cartodb:t,carto:t,raster:t,arcgis:n,featureservice:n,mapservice:n,tileservice:n,esrifeatureservice:n,esrimapservice:n,esritileservice:n,gee:G,loca:U,nexgddp:V,leaflet:Z,wms:Z},this.setEvents=function(e){var n=e.mapLayer,i=e.events;return"cluster"!==e.layerConfig.type&&(r.events[e.id]&&Object.keys(r.events[e.id]).forEach(function(t){n.group?n.eachLayer(function(e){e.off(t)}):n.off(t)}),Object.keys(i).forEach(function(t){n.group?n.eachLayer(function(e){e.on(t,i[t])}):n.on(t,i[t])}),r.events[e.id]=i),r},this.fitMapToLayer=function(e){var t=e.get("mapLayerBounds");t&&r.map.fitBounds(t)},this.map=e}var te=(e(ne,[{key:"get",value:function(e){return this[e]}},{key:"set",value:function(e,t){return this[e]=t,this}},{key:"update",value:function(e){var t=this,n=m({},this),i=m({},e);this.set("changedAttributes",{}),Object.keys(i).forEach(function(e){r(n[e],i[e])||(t.changedAttributes[e]=i[e],t.set(e,i[e]))})}}]),ne);function ne(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};a(this,ne),this.opacity=1,this.visibility=!0,Object.assign(this,e,{changedAttributes:{}})}var ie=(e(re,[{key:"renderLayers",value:function(){var a=this;return 0<this.layers.length?(this.layers.forEach(function(e){var t=e.changedAttributes,n=t.sqlParams,i=t.params,r=t.layerConfig,o=0<Object.keys(t).length,s=n||i||r;if(!s){if(e.mapLayer&&!o)return!1;if(e.mapLayer&&o)return a.updateLayer(e)}return e.mapLayer&&s&&a.updateLayer(e),a.requestLayer(e),a.requestLayerBounds(e),e.set("changedAttributes",{})}),0===Object.keys(this.promises).length?Promise.resolve(this.layers):Promise.all(Object.values(this.promises)).then(function(){return a.layers}).then(function(){a.promises={}})):Promise.resolve(this.layers)}},{key:"add",value:function(e,t){var i=this,r=1<arguments.length&&void 0!==t?t:{opacity:1,visibility:!0,zIndex:0,interactivity:null};return void 0===e?(console.error("layers is required"),this):Array.isArray(e)?(e.forEach(function(t){var e=i.layers.find(function(e){return e.id===t.id}),n=m({},t,r);e?e.update(n):i.layers.push(new te(n))}),this.layers):(console.error("layers should be an array"),this)}},{key:"updateLayer",value:function(e){var t=e.changedAttributes,n=t.opacity,i=t.visibility,r=t.zIndex,o=t.params,s=t.sqlParams,a=t.decodeParams,u=t.layerConfig,c=t.events;void 0!==n&&this.plugin.setOpacity(e,n),void 0!==i&&this.plugin.setOpacity(e,i?e.opacity:0),void 0!==r&&this.plugin.setZIndex(e,r),void 0!==c&&this.setEvents(e),l(u)||this.plugin.setLayerConfig(e),l(o)||this.plugin.setParams(e),l(s)||this.plugin.setParams(e),l(a)||this.plugin.setDecodeParams(e)}},{key:"remove",value:function(e){var n=this,i=this.layers.slice(0),r=Array.isArray(e)?e:[e];this.layers.forEach(function(e,t){r?r.includes(e.id)&&(n.plugin.remove(e),i.splice(t,1)):n.plugin.remove(e)}),this.layers=r?i:[]}},{key:"setOpacity",value:function(t,n){var i=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){i.plugin.setOpacity(e,n)}):console.error("Can't find the layer")}},{key:"setVisibility",value:function(t,n){var i=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){i.plugin.setVisibility(e,n)}):console.error("Can't find the layer")}},{key:"setZIndex",value:function(t,n){var i=this,e=this.layers.filter(function(e){return t.includes(e.id)});e.length?e.forEach(function(e){i.plugin.setZIndex(e,n)}):console.error("Can't find the layer")}},{key:"setEvents",value:function(e){e.events&&this.plugin.setEvents(e)}},{key:"fitMapToLayer",value:function(t){if("function"==typeof this.plugin.fitMapToLayer){var e=this.layers.find(function(e){return e.id===t});e&&this.plugin.fitMapToLayer(e)}else console.error("This plugin does not support fitting map bounds to layer yet.")}},{key:"requestLayer",value:function(n){var i=this,e=n.provider,t=this.plugin.getLayerByProvider(e);return t?(this.promises[n.id]&&this.promises[n.id].isPending&&this.promises[n.id].isPending()&&this.promises[n.id].cancel(),this.promises[n.id]=t.call(this,n).then(function(e){var t=e;n.set("mapLayer",t),i.requestLayerSuccess(n),i.setEvents(n)}),this):(this.promises[n.id]=Promise.reject(new Error(e+" provider is not yet supported.")),!1)}},{key:"requestLayerBounds",value:function(t){var e=t.provider,n=this.plugin.getLayerBoundsByProvider(e);if(!n)return!1;var i=t.id+"_bounds";return this.promises[i]&&this.promises[i].isPending&&this.promises[i].isPending()&&this.promises[i].cancel(),this.promises[i]=n.call(this,t).then(function(e){t.set("mapLayerBounds",e)}),this}}]),re);function re(e,t){var n=this;a(this,re),this.requestLayerSuccess=i(function(e){n.plugin.add(e),n.plugin.setZIndex(e,e.zIndex),n.plugin.setOpacity(e,e.opacity),n.plugin.setVisibility(e,e.visibility)},50),this.map=e,this.plugin=new t(this.map),function(t){if(t){["add","remove","setVisibility","setOpacity","setEvents","setZIndex","setLayerConfig","setParams","setDecodeParams","getLayerByProvider"].forEach(function(e){t[e]||console.error("The "+e+" function is required for layer manager plugins")})}}(this.plugin),this.layers=[],this.promises={}}return ie.PluginLeaflet=$,ie.replace=y,ie.substitution=c,ie.concatenation=h,ie});
